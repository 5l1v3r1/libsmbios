# these are all substituted by autoconf
%define major @RELEASE_MAJOR@
%define minor @RELEASE_MINOR@
%define sub @RELEASE_SUBLEVEL@
%define extralevel @RELEASE_RPM_EXTRALEVEL@
%define release_name libsmbios
%define release_version %{major}.%{minor}.%{sub}%{extralevel}

%define cppunit_BR cppunit-devel
%define doxygen_BR %{nil}
%define valgrind_BR %{nil}
# Some variable definitions so that we can be compatible between SUSE Build service and Fedora build system
# SUSE: fedora_version  suse_version rhel_version centos_version sles_version
# Fedora: fedora dist fc8 fc9
%if 0%{?fedora_version} || 0%{?fedora}
    %define doxygen_BR doxygen
%endif

# no doxygen in most suse versions base
%if 0%{?suse_version}
    %define valgrind_BR valgrind
%endif

%if 0%{?sles_version}
    %define valgrind_BR valgrind
%endif

%if 0%{?rhel_version}
    %define doxygen_BR doxygen
%endif

%if 0%{?centos_version}
    %define doxygen_BR doxygen
%endif

# per fedora python packaging guidelines
%{!?python_sitelib: %define python_sitelib %(%{__python} -c "from distutils.sysconfig import get_python_lib; print get_python_lib()")}

Name: libsmbios_c
Version: %{release_version}
Release: 1%{?dist}
License: GPLv2+ or OSL 2.1
Summary: Libsmbios C shared libraries
Group: System Environment/Libraries
Source: http://linux.dell.com/libsmbios/download/libsmbios/libsmbios-%{version}/libsmbios-%{version}.tar.gz
URL: http://linux.dell.com/libsmbios/main
Buildroot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
BuildRequires: libxml2-devel
#BuildRequires: %{valgrind_BR}
BuildRequires: gcc-c++, gettext, %{doxygen_BR}, %{cppunit_BR}

# libsmbios only ever makes sense on intel compatible arches
# no DMI tables on ppc, s390, etc.
ExclusiveArch: x86_64 ia64 %{ix86}

%description -n libsmbios_c
Libsmbios is a library and utilities that can be used by client programs
to get information from standard BIOS tables, such as the SMBIOS table.

This package provides the C-based libsmbios library, with a C interface.

%package -n libsmbios_c++
Summary: Libsmbios C++ shared libraries
Group: System Environment/Libraries
Provides: libsmbios = %{epoch}:%{version}-%{release}
Provides: libsmbios-libs = %{epoch}:%{version}-%{release}
# uncomment for official fedora
#Obsoletes: libsmbios-libs < 2.0.0

%description -n libsmbios_c++
Libsmbios is a library and utilities that can be used by client programs
to get information from standard BIOS tables, such as the SMBIOS table.

This package has a C++-based library, with a C++ interface. It is not actively maintained, but provided for backwards compatibility. New programs should use the libsmbios C interface.

%package -n libsmbios_c-python
Summary: Python interface to Libsmbios C library
Group: System Environment/Libraries
Requires: libsmbios_c

%description -n libsmbios_c-python
This package provides a Python interface to libsmbios


%package -n smbios-utils
Summary: Utilities that use libsmbios
Group: Applications/System
Requires: libsmbios_c-python = %{version}-%{release}
Requires: libsmbios_c = %{version}-%{release}
Requires: libsmbios_c++ = %{version}-%{release}
Obsoletes: libsmbios-bin < 0:2.0.0
Provides: libsmbios-bin = %{version}-%{release}
Obsoletes: libsmbios-unsupported-bin < 0:2.0.0
Provides: libsmbios-unsupported-bin = %{version}-%{release}

%package -n libsmbios_c++-devel
Summary: Development headers and archives
Group: Development/Libraries
Requires: libsmbios_c++ = %{version}-%{release}
Provides: libsmbios-devel

%description -n libsmbios_c++-devel
Libsmbios is a library and utilities that can be used by client programs
to get information from standard BIOS tables, such as the SMBIOS table.

This package contains the headers and .a files necessary to compile new
client programs against libsmbios.


%package -n libsmbios_c-devel
Summary: Development headers and archives
Group: Development/Libraries
Requires: libsmbios_c = %{version}-%{release}

%description -n libsmbios_c-devel
Libsmbios is a library and utilities that can be used by client programs
to get information from standard BIOS tables, such as the SMBIOS table.

This package contains the headers and .a files necessary to compile new
client programs against libsmbios.

%description -n smbios-utils
Libsmbios is a library and utilities that can be used by client programs
to get information from standard BIOS tables, such as the SMBIOS table.

This package contains some sample binaries that use libsmbios.

%prep
%setup -q -n libsmbios-%{version}
find . -type d -exec chmod -f 755 {} \;
find doc src -type f -exec chmod -f 644 {} \;
chmod 755 src/cppunit/*.sh

%build
# this line lets us build an RPM directly from a git tarball
[ -e ./configure ] || ./autogen.sh

export CXXFLAGS="%{optflags}"
export CFLAGS="%{optflags}"
export RELEASE_MAJOR=%{major}
export RELEASE_MINOR=%{minor}
export RELEASE_SUBLEVEL=%{sub}
export RELEASE_EXTRALEVEL=%{extralevel}
%configure
mkdir -p out/libsmbios_c
mkdir -p out/libsmbios_c++
make -e %{?_smp_mflags}

%check
#if [ -e /usr/bin/valgrind -a -d /usr/include/cppunit ]; then
#    make -e valgrind
#elif [ -d /usr/include/cppunit ]; then
#    make -e check
#else
#    echo "Unit tests skipped due to missing cppunit."
#fi

%install
rm -rf %{buildroot}

make install DESTDIR=%{buildroot} INSTALL="%{__install} -p"
mkdir -p %{buildroot}/usr/include
cp -a src/include/*  %{buildroot}/usr/include/
rm -f %{buildroot}/%{_libdir}/lib*.la
find %{buildroot}/usr/include -exec touch -r configure.ac {} \;

# backwards compatible:
ln -s /usr/sbin/dellWirelessCtl %{buildroot}/usr/bin/dellWirelessCtl

%find_lang libsmbios


%clean
rm -rf %{buildroot}

%post   -n libsmbios_c++ -p /sbin/ldconfig
%postun -n libsmbios_c++ -p /sbin/ldconfig
%post   -n libsmbios_c   -p /sbin/ldconfig
%postun -n libsmbios_c   -p /sbin/ldconfig

%files -n libsmbios_c++
%defattr(-,root,root,-)
%doc COPYING-GPL COPYING-OSL README
%{_libdir}/libsmbios.so.*

%files -n libsmbios_c -f libsmbios.lang
%defattr(-,root,root,-)
%doc COPYING-GPL COPYING-OSL README
%{_libdir}/libsmbios_c.so.*

%files -n libsmbios_c-python
%defattr(-,root,root,-)
%doc COPYING-GPL COPYING-OSL README
%{python_sitelib}/*

%files -n libsmbios_c++-devel
%defattr(-,root,root,-)
%doc COPYING-GPL COPYING-OSL README src/bin/getopts_LICENSE.txt src/include/smbios/config/boost_LICENSE_1_0_txt
/usr/include/smbios
%{_libdir}/libsmbios.a
%{_libdir}/libsmbios.so
%doc out/libsmbios_c++

%files -n libsmbios_c-devel
%defattr(-,root,root,-)
%doc COPYING-GPL COPYING-OSL README src/bin/getopts_LICENSE.txt
/usr/include/smbios_c
%{_libdir}/libsmbios_c.a
%{_libdir}/libsmbios_c.so
%doc out/libsmbios_c++

%files -n smbios-utils
%defattr(-,root,root,-)
%doc COPYING-GPL COPYING-OSL README
%doc src/bin/getopts_LICENSE.txt src/include/smbios/config/boost_LICENSE_1_0_txt
%doc doc/pkgheader.sh
%{_sbindir}/assetTag
%{_sbindir}/dellBiosUpdate
%{_sbindir}/getSystemId
%{_sbindir}/propertyTag
%{_sbindir}/serviceTag
%{_sbindir}/verifySmiPassword
%{_sbindir}/wakeupCtl
%{_sbindir}/dellLcdBrightness
%{_sbindir}/mkbiospkg.sh
%{_sbindir}/dellLEDCtl
%{_sbindir}/activateCmosToken
%{_sbindir}/getPasswordFormat
%{_sbindir}/isCmosTokenActive
%{_sbindir}/stateByteCtl
%{_sbindir}/upBootCtl
%{_sbindir}/smbios_cmos_save_to_file

# used by HAL in old location, so keep it around until HAL is updated.
%{_sbindir}/dellWirelessCtl
# this is a symlink to the above...
%{_bindir}/dellWirelessCtl

%ifnarch ia64
%{_sbindir}/dellMediaDirectCtl
%endif

# python utilities
%{_sbindir}/tokenCtl
%{_datadir}/smbios-utils


# ./ChangeLog is appended by configure
%changelog
